<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Digital Code Vault â€” Email Security (MCQ + Recovery)</title>
<style>
  :root{
    --bg0:#050816;
    --bg1:#070b1d;

    --ink:#EAF1FF;
    --muted:#A9B6D7;

    --panel: rgba(255,255,255,.06);
    --stroke: rgba(255,255,255,.12);

    --cyan:#55D6FF;
    --cyan2:#2C7BFF;

    --good:#2EE59D;
    --bad:#FF5A7A;

    --gold1:#F7D36A;
    --gold2:#B8872B;

    --shadow: 0 18px 70px rgba(0,0,0,.55);
    --r: 18px;
  }

  *{box-sizing:border-box}
  body{
    margin:0; color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    min-height:100vh;
    display:flex; justify-content:center; align-items:center;
    padding:16px;
    background:
      radial-gradient(1100px 650px at 50% 20%, rgba(85,214,255,.22), rgba(85,214,255,0) 55%),
      radial-gradient(900px 550px at 20% 70%, rgba(44,123,255,.18), rgba(44,123,255,0) 60%),
      radial-gradient(900px 550px at 80% 70%, rgba(162,28,255,.14), rgba(162,28,255,0) 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    overflow-x:hidden;
  }
  .wrap{width:min(1120px, 100%);}

  header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    margin-bottom:12px; flex-wrap:wrap;
  }
  .brand{display:flex; align-items:center; gap:10px;}
  .logo{
    width:44px;height:44px;border-radius:14px;
    background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), rgba(85,214,255,.55) 35%, rgba(44,123,255,.75) 70%, rgba(0,0,0,.35));
    box-shadow: 0 12px 30px rgba(85,214,255,.18);
    border:1px solid rgba(255,255,255,.14);
  }
  .title h1{margin:0;font-size:16.5px;letter-spacing:.2px}
  .title p{margin:2px 0 0;color:var(--muted);font-size:12.5px;line-height:1.25}

  .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .pill{
    display:flex; align-items:center; gap:8px;
    padding:10px 12px;
    border-radius:999px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    backdrop-filter: blur(8px);
  }
  .pill span{color:var(--muted); font-size:12.5px}
  .pill b{font-size:13px}
  .btn{
    appearance:none; border:0; cursor:pointer;
    padding:10px 12px;
    border-radius:12px;
    color:var(--ink);
    background: rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    box-shadow: 0 10px 26px rgba(0,0,0,.25);
    transition: transform .12s ease, filter .12s ease;
  }
  .btn:hover{transform: translateY(-1px); filter: brightness(1.05)}
  .btn:active{transform: translateY(0)}
  .btn.primary{
    background: linear-gradient(180deg, rgba(85,214,255,.95), rgba(44,123,255,.95));
    border:1px solid rgba(255,255,255,.18);
  }
  .btn.danger{
    background: linear-gradient(180deg, rgba(255,90,122,.95), rgba(225,29,72,.95));
    border:1px solid rgba(255,255,255,.16);
  }

  .grid{
    display:grid;
    grid-template-columns: 1.35fr .85fr;
    gap:14px;
  }
  @media (max-width: 920px){ .grid{grid-template-columns: 1fr;} }

  /* ===== Main board ===== */
  .board{
    border-radius: var(--r);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.12);
    box-shadow: var(--shadow);
    overflow:hidden;
    position:relative;
  }
  .boardInner{padding:14px; position:relative;}

  .starfield{
    position:absolute; inset:0;
    background:
      radial-gradient(2px 2px at 12% 18%, rgba(255,255,255,.6), rgba(255,255,255,0) 60%),
      radial-gradient(2px 2px at 22% 72%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
      radial-gradient(2px 2px at 66% 22%, rgba(255,255,255,.5), rgba(255,255,255,0) 60%),
      radial-gradient(2px 2px at 82% 64%, rgba(255,255,255,.55), rgba(255,255,255,0) 60%),
      radial-gradient(2px 2px at 48% 80%, rgba(255,255,255,.45), rgba(255,255,255,0) 60%),
      radial-gradient(2px 2px at 90% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 60%);
    opacity:.55;
    pointer-events:none;
  }

  .arena{
    border-radius: 18px;
    background:
      radial-gradient(900px 600px at 50% 30%, rgba(85,214,255,.18), rgba(85,214,255,0) 60%),
      linear-gradient(180deg, rgba(7,12,28,.92), rgba(5,8,18,.92));
    border:1px solid rgba(255,255,255,.10);
    padding:16px;
    position:relative;
    overflow:hidden;
  }

  /* animated grid for "near actual" look */
  .gridFX{
    position:absolute; inset:-40% -20%;
    background:
      linear-gradient(rgba(85,214,255,.08) 1px, transparent 1px),
      linear-gradient(90deg, rgba(85,214,255,.06) 1px, transparent 1px);
    background-size: 42px 42px;
    transform: perspective(800px) rotateX(58deg) translateY(28%);
    opacity:.25;
    animation: gridMove 8s linear infinite;
    pointer-events:none;
  }
  @keyframes gridMove{
    from{background-position: 0 0, 0 0;}
    to{background-position: 0 120px, 120px 0;}
  }

  .scanLine{
    position:absolute;
    left:-40%;
    top:0;
    width:40%;
    height:100%;
    background: linear-gradient(90deg, rgba(255,255,255,0), rgba(85,214,255,.22), rgba(255,255,255,0));
    transform: skewX(-16deg);
    animation: scan 4.4s ease-in-out infinite;
    opacity:.55;
    pointer-events:none;
  }
  @keyframes scan{
    0%, 30%{transform: translateX(-60%) skewX(-16deg)}
    70%{transform: translateX(290%) skewX(-16deg)}
    100%{transform: translateX(290%) skewX(-16deg)}
  }

  .topRow{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    margin-bottom:12px;
  }
  .kicker{
    color:var(--muted);
    font-size:12.5px;
    line-height:1.35;
  }
  .kbd{
    font-size:12px; color:var(--muted);
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
  }

  /* ===== Digital lock board ===== */
  .lockBoard{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:14px;
    align-items:center;
  }
  @media (max-width: 820px){ .lockBoard{grid-template-columns: 1fr;} }

  .digitsPanel{
    border-radius: 18px;
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    padding:14px;
    position:relative;
    overflow:hidden;
  }
  .digitsPanel::after{
    content:"";
    position:absolute; inset:-60% -40% auto -40%;
    height:70%;
    background: radial-gradient(circle at 50% 60%, rgba(85,214,255,.14), rgba(85,214,255,0) 70%);
    pointer-events:none;
  }

  .digitsTitle{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; flex-wrap:wrap;
    margin-bottom:10px;
    position:relative;
    z-index:1;
  }
  .digitsTitle b{font-size:13px; letter-spacing:.2px}
  .digitsTitle small{color:var(--muted); font-size:12px}

  .digits{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    position:relative;
    z-index:1;
  }
  .digit{
    width:44px; height:52px;
    border-radius:12px;
    display:flex; align-items:center; justify-content:center;
    font-size:22px;
    font-weight:900;
    letter-spacing:.5px;
    position:relative;
    border:1px solid rgba(255,255,255,.12);
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.30);
  }
  .digit .blur{
    width:18px;height:18px;border-radius:50%;
    background: rgba(255,255,255,.30);
    filter: blur(6px);
    opacity:.85;
  }
  .digit.revealed{
    background:
      radial-gradient(140px 60px at 50% 35%, rgba(85,214,255,.20), rgba(85,214,255,0) 60%),
      linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
    border-color: rgba(85,214,255,.40);
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.35),
      0 0 26px rgba(85,214,255,.20);
  }
  .digit.revealed span{
    color: rgba(234,241,255,.96);
    text-shadow: 0 0 16px rgba(85,214,255,.38);
  }
  .digit.revealPop{ animation: revealPop .42s cubic-bezier(.2,.9,.2,1); }
  @keyframes revealPop{
    0%{transform: scale(.90); filter: brightness(.90)}
    65%{transform: scale(1.08); filter: brightness(1.18)}
    100%{transform: scale(1); filter: brightness(1)}
  }

  .digitsAllGlow .digit.revealed{
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.35),
      0 0 38px rgba(247,211,106,.22),
      0 0 26px rgba(85,214,255,.18);
    border-color: rgba(247,211,106,.35);
  }

  .progressRow{
    margin-top:12px;
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    position:relative;
    z-index:1;
  }
  .bar{
    width:240px; height:10px; border-radius:999px;
    background: rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.10);
    overflow:hidden;
  }
  .bar > i{
    display:block; height:100%; width:0%;
    background: linear-gradient(90deg, rgba(46,229,157,.95), rgba(85,214,255,.95));
    border-radius:999px;
    transition: width .35s ease;
  }
  .hint{color:var(--muted); font-size:12.5px}

  /* ===== Vault stage (more attractive sequence) ===== */
  .vaultStage{
    border-radius: 18px;
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    padding:14px;
    position:relative;
    overflow:hidden;
    min-height: 270px;
  }
  .vaultStage::before{
    content:"";
    position:absolute; inset:-40% -30% auto -30%;
    height:60%;
    background: radial-gradient(circle at 50% 60%, rgba(247,211,106,.16), rgba(247,211,106,0) 70%);
    pointer-events:none;
  }
  .lockGlow{
    position:absolute;
    width:280px;height:280px;border-radius:50%;
    left:50%; top:45%;
    transform: translate(-50%,-50%);
    background: radial-gradient(circle at 50% 50%, rgba(85,214,255,.35), rgba(85,214,255,0) 68%);
    pointer-events:none;
    opacity:.95;
    animation: glowBreath 3.2s ease-in-out infinite;
  }
  @keyframes glowBreath{
    0%,100%{transform: translate(-50%,-50%) scale(1); opacity:.85}
    50%{transform: translate(-50%,-50%) scale(1.05); opacity:1}
  }

  .ringsFX{
    position:absolute; inset:0;
    pointer-events:none;
    opacity:.75;
  }
  .ringsFX svg{width:100%; height:100%;}
  .spinSlow{transform-origin:50% 55%; animation: spin 10s linear infinite;}
  .spinFast{transform-origin:50% 55%; animation: spin 5.4s linear infinite;}
  @keyframes spin{from{transform:rotate(0deg)} to{transform:rotate(360deg)}}

  .vaultSvg{
    width:100%;
    height:250px;
    display:block;
    filter: drop-shadow(0 18px 26px rgba(0,0,0,.55));
    position:relative;
    z-index:1;
  }

  .unlockPulse{ animation: unlockPulse .55s ease; }
  @keyframes unlockPulse{
    0%{filter: brightness(1)}
    50%{filter: brightness(1.18)}
    100%{filter: brightness(1)}
  }

  .shake{ animation: shake .35s ease; }
  @keyframes shake{
    0%{transform: translateX(0)}
    25%{transform: translateX(-5px)}
    50%{transform: translateX(5px)}
    75%{transform: translateX(-4px)}
    100%{transform: translateX(0)}
  }

  /* vault opening animation using CSS vars */
  #doorL, #doorR, #shackle, #lockBody, #keyhole{
    transition: transform 1.05s ease, filter .8s ease;
    transform-origin:center;
  }
  .vaultDoorsOpen #doorL{ transform: translateX(-88px) rotate(-1deg); }
  .vaultDoorsOpen #doorR{ transform: translateX(88px) rotate(1deg); }
  .vaultDoorsOpen #shackle{ transform: translateY(-22px); }
  .vaultDoorsOpen #lockBody{ filter: brightness(1.15); }
  .vaultDoorsOpen #keyhole{ filter: brightness(1.25); }

  .lightBurst{
    position:absolute;
    inset:0;
    background:
      radial-gradient(circle at 50% 55%, rgba(247,211,106,.35), rgba(247,211,106,0) 60%),
      radial-gradient(circle at 50% 55%, rgba(85,214,255,.18), rgba(85,214,255,0) 70%);
    opacity:0;
    pointer-events:none;
  }
  .vaultDoorsOpen .lightBurst{
    opacity:1;
    transition: opacity .9s ease;
  }

  .rays{
    position:absolute;
    left:50%; top:55%;
    width:520px; height:520px;
    transform: translate(-50%,-50%);
    background: conic-gradient(
      from 0deg,
      rgba(247,211,106,.0),
      rgba(247,211,106,.20),
      rgba(247,211,106,.0),
      rgba(85,214,255,.14),
      rgba(247,211,106,.0),
      rgba(247,211,106,.18),
      rgba(247,211,106,.0)
    );
    mask-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 0%, rgba(0,0,0,1) 35%, rgba(0,0,0,0) 65%);
    opacity:0;
    pointer-events:none;
    animation: raysSpin 6s linear infinite;
  }
  @keyframes raysSpin{from{transform:translate(-50%,-50%) rotate(0deg)} to{transform:translate(-50%,-50%) rotate(360deg)}}
  .vaultDoorsOpen .rays{opacity:.9; transition: opacity .6s ease;}

  /* ===== Right panel ===== */
  .side{
    border-radius: var(--r);
    background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.12);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .sideInner{padding:14px}
  .sideInner h2{margin:0;font-size:15px}
  .sideInner p{margin:6px 0 0; color:var(--muted); font-size:12.5px; line-height:1.35}
  .stats{
    margin-top:12px;
    display:grid; grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .stat{
    border-radius: 14px;
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    padding:10px;
  }
  .stat b{display:block;font-size:16px}
  .stat span{display:block;color:var(--muted);font-size:12px;margin-top:2px}
  .note{
    margin-top:12px;
    border-radius: 14px;
    padding:10px;
    background: rgba(85,214,255,.10);
    border:1px solid rgba(85,214,255,.20);
    font-size:12.5px; line-height:1.35;
  }

  /* ===== Modal ===== */
  .overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.58);
    display:none;
    align-items:center; justify-content:center;
    padding:16px;
    z-index:50;
  }
  .overlay.show{display:flex}
  .modal{
    width:min(820px, 100%);
    border-radius: 18px;
    background: linear-gradient(180deg, rgba(20,34,66,.96), rgba(9,12,22,.96));
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: 0 30px 120px rgba(0,0,0,.65);
    overflow:hidden;
    position:relative;
  }
  .modal::before{
    content:"";
    position:absolute; inset:-60% -40% auto -40%;
    height:65%;
    background: radial-gradient(circle at 50% 60%, rgba(247,211,106,.18), rgba(247,211,106,0) 70%);
    pointer-events:none;
  }
  .mHead{
    padding:14px 14px 10px;
    display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    position:relative;
  }
  .mHead h3{margin:0; font-size:15.5px}
  .mHead small{display:block; color:var(--muted); margin-top:4px}

  .badge{
    display:inline-flex; align-items:center; gap:8px;
    margin-top:8px;
    padding:6px 10px;
    border-radius: 999px;
    font-size:12px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color: var(--muted);
  }
  .badge.good{border-color: rgba(46,229,157,.30); background: rgba(46,229,157,.10); color: rgba(234,241,255,.92);}
  .badge.bad{border-color: rgba(255,90,122,.30); background: rgba(255,90,122,.10); color: rgba(234,241,255,.92);}

  .mBody{padding:0 14px 14px; position:relative;}
  .qText{
    margin:10px 0 12px;
    font-size:15px;
    line-height:1.45;
  }
  .choices{display:grid; gap:10px;}
  .choice{
    width:100%;
    text-align:left;
    padding:12px 12px;
    border-radius:14px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
    color:var(--ink);
    cursor:pointer;
    transition: transform .10s ease, background .12s ease, border-color .12s ease;
  }
  .choice:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
  .choice:active{transform: translateY(0px)}
  .choice[disabled]{cursor:not-allowed; opacity:.80}
  .choice.good{
    border-color: rgba(46,229,157,.45);
    background: rgba(46,229,157,.12);
  }
  .choice.bad{
    border-color: rgba(255,90,122,.45);
    background: rgba(255,90,122,.10);
  }
  .mFoot{
    display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    padding:12px 14px 14px;
    border-top:1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.12);
    position:relative;
  }

  .toast{
    position:fixed;
    left:50%; top:18px; transform:translateX(-50%);
    padding:10px 12px;
    border-radius: 999px;
    background: rgba(0,0,0,.55);
    border: 1px solid rgba(255,255,255,.15);
    color: var(--ink);
    font-size: 12.5px;
    display:none;
    z-index:80;
    backdrop-filter: blur(10px);
  }
  .toast.show{display:block; animation: pop .18s ease}
  @keyframes pop{from{transform:translateX(-50%) scale(.95); opacity:.6} to{transform:translateX(-50%) scale(1); opacity:1}}

  /* Confetti + sparks canvas */
  .confetti, .sparks{
    position:absolute; inset:0;
    pointer-events:none;
    opacity:0;
  }
  .confetti.show, .sparks.show{opacity:1; animation: fadeOut 1.2s ease forwards}
  @keyframes fadeOut{0%{opacity:1} 100%{opacity:0}}

  /* Final banner */
  .finalBanner{
    position:absolute;
    left:50%; top:50%;
    transform: translate(-50%,-50%);
    padding:12px 14px;
    border-radius: 16px;
    background: rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.16);
    backdrop-filter: blur(10px);
    box-shadow: 0 18px 60px rgba(0,0,0,.55);
    font-weight:900;
    letter-spacing:.3px;
    display:none;
    z-index:6;
    text-align:center;
    width:min(520px, 92%);
  }
  .finalBanner.show{display:block; animation: pop .18s ease}
  .finalBanner small{display:block; margin-top:6px; font-weight:600; color:var(--muted); font-size:12.5px}

  .cinematicText{
    position:absolute;
    left:50%;
    top:18px;
    transform: translateX(-50%);
    padding:10px 12px;
    border-radius: 999px;
    background: rgba(0,0,0,.42);
    border:1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(10px);
    font-weight:800;
    letter-spacing:.2px;
    display:none;
    z-index:6;
    color: rgba(234,241,255,.95);
  }
  .cinematicText.show{display:block; animation: pop .18s ease}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <h1>Digital Code Vault â€” Email Security</h1>
        <p>Correct answers reveal digits. A wrong answer gives one recovery (True/False). Reveal all digits to unlock the vault.</p>
      </div>
    </div>

    <div class="actions">
      <div class="pill"><span>Digits</span><b id="done">0</b><span>/</span><b id="total">10</b></div>
      <div class="pill"><span>Score</span><b id="score">0</b></div>
      <button class="btn" id="muteBtn" type="button">ðŸ”Š Sound</button>
      <button class="btn primary" id="startBtn" type="button">Start</button>
      <button class="btn danger" id="resetBtn" type="button">Reset</button>
    </div>
  </header>

  <div class="grid">
    <section class="board">
      <div class="starfield"></div>
      <div class="boardInner">
        <div class="arena" id="arena">
          <div class="gridFX"></div>
          <div class="scanLine"></div>

          <div class="topRow">
            <div class="kicker" id="kicker">
              <b>Rule:</b> One digit needs one correct answer. If you answer wrong, you get <b>one</b> recovery question (True/False).
            </div>
            <span class="kbd" id="nextHint">Press Start</span>
          </div>

          <div class="lockBoard">
            <div class="digitsPanel" id="digitsPanel">
              <div class="digitsTitle">
                <b>10-Digit Lock Code</b>
                <small id="progressText">Digits Verified: 0 / 10</small>
              </div>

              <div class="digits" id="digits"></div>

              <div class="progressRow">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                  <div class="bar"><i id="barFill"></i></div>
                  <span class="hint" id="barText">0% verified</span>
                </div>
                <span class="hint" id="streakText">Streak: 0</span>
              </div>
            </div>

            <div class="vaultStage" id="vaultStage">
              <div class="lockGlow"></div>

              <div class="ringsFX" aria-hidden="true">
                <svg viewBox="0 0 640 300" preserveAspectRatio="none">
                  <g class="spinSlow">
                    <circle cx="320" cy="165" r="118" fill="none" stroke="rgba(85,214,255,.16)" stroke-width="2"/>
                    <circle cx="320" cy="165" r="92" fill="none" stroke="rgba(85,214,255,.10)" stroke-width="2"/>
                  </g>
                  <g class="spinFast">
                    <circle cx="320" cy="165" r="76" fill="none" stroke="rgba(46,229,157,.10)" stroke-width="2"/>
                    <circle cx="320" cy="165" r="58" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="2"/>
                  </g>
                </svg>
              </div>

              <div class="lightBurst"></div>
              <div class="rays"></div>

              <!-- Vault + Lock SVG -->
              <svg class="vaultSvg" viewBox="0 0 640 300" aria-label="Vault and lock illustration">
                <defs>
                  <linearGradient id="steel" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0" stop-color="#E6EDF8"/>
                    <stop offset=".35" stop-color="#9AA6B8"/>
                    <stop offset="1" stop-color="#2B3445"/>
                  </linearGradient>
                  <linearGradient id="door" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0" stop-color="#1B2640"/>
                    <stop offset=".55" stop-color="#101a2f"/>
                    <stop offset="1" stop-color="#0a1020"/>
                  </linearGradient>
                  <radialGradient id="vaultGlow" cx="50%" cy="55%" r="65%">
                    <stop offset="0" stop-color="rgba(85,214,255,.35)"/>
                    <stop offset="70%" stop-color="rgba(85,214,255,.08)"/>
                    <stop offset="100%" stop-color="rgba(85,214,255,0)"/>
                  </radialGradient>
                </defs>

                <circle cx="320" cy="165" r="120" fill="url(#vaultGlow)" opacity=".9"/>

                <!-- Vault frame -->
                <rect x="160" y="70" width="320" height="190" rx="26" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.12)"/>
                <rect x="180" y="90" width="280" height="150" rx="20" fill="rgba(0,0,0,.22)" stroke="rgba(255,255,255,.10)"/>

                <!-- Doors -->
                <g id="doorL">
                  <rect x="184" y="94" width="140" height="142" rx="16" fill="url(#door)" stroke="rgba(255,255,255,.10)"/>
                  <circle cx="254" cy="165" r="19" fill="rgba(0,0,0,.30)" stroke="rgba(255,255,255,.10)"/>
                  <circle cx="254" cy="165" r="6" fill="rgba(85,214,255,.45)"/>
                  <path d="M210 120h88" stroke="rgba(255,255,255,.08)" stroke-width="3" stroke-linecap="round"/>
                  <path d="M210 140h88" stroke="rgba(255,255,255,.06)" stroke-width="3" stroke-linecap="round"/>
                </g>

                <g id="doorR">
                  <rect x="316" y="94" width="140" height="142" rx="16" fill="url(#door)" stroke="rgba(255,255,255,.10)"/>
                  <circle cx="386" cy="165" r="19" fill="rgba(0,0,0,.30)" stroke="rgba(255,255,255,.10)"/>
                  <circle cx="386" cy="165" r="6" fill="rgba(85,214,255,.45)"/>
                  <path d="M342 120h88" stroke="rgba(255,255,255,.08)" stroke-width="3" stroke-linecap="round"/>
                  <path d="M342 140h88" stroke="rgba(255,255,255,.06)" stroke-width="3" stroke-linecap="round"/>
                </g>

                <!-- Lock in front -->
                <g>
                  <circle cx="320" cy="186" r="88" fill="rgba(85,214,255,.08)" stroke="rgba(85,214,255,.14)"/>

                  <path id="shackle" d="M280 184v-34c0-26 16-42 40-42s40 16 40 42v34"
                        fill="none" stroke="url(#steel)" stroke-width="12" stroke-linecap="round"/>

                  <path id="lockBody" d="M256 184h128c12 0 22 10 22 22v50c0 26-20 46-46 46h-80c-26 0-46-20-46-46v-50c0-12 10-22 22-22z"
                        fill="url(#door)" stroke="rgba(255,255,255,.14)" stroke-width="2"/>

                  <circle cx="320" cy="232" r="34" fill="rgba(0,0,0,.25)" stroke="rgba(85,214,255,.18)" stroke-width="2"/>
                  <path id="keyhole" d="M320 218c-8 0-14 6-14 14 0 5 3 10 8 12v20c0 3 2 5 6 5s6-2 6-5v-20c5-2 8-7 8-12 0-8-6-14-14-14z"
                        fill="rgba(85,214,255,.86)"/>
                </g>
              </svg>

              <canvas class="sparks" id="sparks"></canvas>
              <canvas class="confetti" id="confetti"></canvas>

              <div class="cinematicText" id="cinematicText">VERIFYING ACCESSâ€¦</div>

              <div class="finalBanner" id="finalBanner">
                ACCESS GRANTED â€” VAULT OPENED
                <small id="finalSub">All digits verified.</small>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <aside class="side">
      <div class="sideInner">
        <h2>Session Summary</h2>
        <p>Simple mechanics, strong visuals, and clean learning analytics.</p>

        <div class="stats">
          <div class="stat"><b id="acc">0%</b><span>Accuracy</span></div>
          <div class="stat"><b id="time">0s</b><span>Time</span></div>
          <div class="stat"><b id="correct">0</b><span>Correct</span></div>
          <div class="stat"><b id="wrong">0</b><span>Wrong</span></div>
        </div>

        <div class="note" id="note">
          <b>Status:</b> Press <b>Start</b> to begin. You will answer one MCQ per digit.
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Modal -->
<div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Question modal">
  <div class="modal" id="modal">
    <div class="mHead">
      <div>
        <h3 id="mTitle">Digit 1</h3>
        <small id="mSub">One attempt â€¢ Recovery appears only if wrong</small>
        <div id="modeBadge" class="badge">MAIN QUESTION</div>
      </div>
      <button class="btn" id="closeBtn" type="button">Close</button>
    </div>

    <div class="mBody">
      <div class="qText" id="qText"></div>
      <div class="choices" id="choices"></div>
    </div>

    <div class="mFoot">
      <div id="feedback" style="color:var(--muted)">Choose the best answer.</div>
      <button class="btn primary" id="nextBtn" type="button" disabled>Continue</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ============================================================
   Question Bank â€” framed naturally (no "chapter says" wording)
   Topics included:
   - Spam / scam warning signs
   - Encryption limits (metadata not encrypted)
   - OpenPGP in Thunderbird (Enigmail + GnuPG)
   - Inline PGP vs PGP/MIME
============================================================ */

/* Recovery format: True/False
   Convention: 0 = True, 1 = False
*/
const QUESTION_BANK = [
  {
    q: "You receive an email from an unknown sender offering a â€œlimited-timeâ€ discount. What is the safest interpretation?",
    choices: [
      "This is a normal marketing email and safe to act on",
      "It is a warning sign and should be treated cautiously",
      "It is guaranteed to be legitimate if it uses a logo",
      "It is safe if it has no attachments"
    ],
    answerIndex: 1,
    feedbackCorrect: "Correct: Unknown sender + urgency is a common warning pattern.",
    feedbackWrong: "Not quite. Unknown sender and urgent offers are strong warning signs.",
    recovery: { q: "True/False: An unknown sender with an urgent offer can be a warning sign.", answerIndex: 0 }
  },
  {
    q: "Some spam emails use odd spellings (example: swapping letters with numbers). Why is that done?",
    choices: [
      "To reduce the email size",
      "To bypass keyword-based spam filters",
      "To encrypt the message automatically",
      "To make the email load faster"
    ],
    answerIndex: 1,
    feedbackCorrect: "Correct: Misspellings are often used to evade spam filtering.",
    feedbackWrong: "Not quite. Such spellings are commonly used to evade spam filters.",
    recovery: { q: "True/False: Misspellings can be used to bypass basic spam filtering.", answerIndex: 0 }
  },
  {
    q: "Which situation is a clear red flag in email reading?",
    choices: [
      "The subject and the email content do not match",
      "The email has a polite greeting",
      "The email is sent during office hours",
      "The email uses simple language"
    ],
    answerIndex: 0,
    feedbackCorrect: "Correct: Subject-content mismatch is a strong warning sign.",
    feedbackWrong: "Not quite. Subject-content mismatch is a strong warning sign.",
    recovery: { q: "True/False: If the subject and content do not match, it can be suspicious.", answerIndex: 0 }
  },
  {
    q: "An email asks you to forward it to many people and promises a reward. What should you do?",
    choices: [
      "Forward it quickly to qualify for the reward",
      "Treat it as suspicious and avoid forwarding",
      "Reply asking for proof",
      "Click links to confirm it is real"
    ],
    answerIndex: 1,
    feedbackCorrect: "Correct: Forwarding chains and reward promises are common scam patterns.",
    feedbackWrong: "Not quite. Forwarding chains and reward promises are common scam patterns.",
    recovery: { q: "True/False: Requests to forward a message widely can be suspicious.", answerIndex: 0 }
  },
  {
    q: "Which attachment type is often risky if unexpected?",
    choices: [
      ".exe",
      ".txt",
      ".jpg",
      ".pdf"
    ],
    answerIndex: 0,
    feedbackCorrect: "Correct: Unexpected executable files are risky.",
    feedbackWrong: "Not quite. Unexpected executable files are risky.",
    recovery: { q: "True/False: Unexpected .exe attachments are risky.", answerIndex: 0 }
  },
  {
    q: "In Thunderbird, what combination is commonly used to enable OpenPGP email encryption features?",
    choices: [
      "Enigmail + GnuPG",
      "IMAP + POP",
      "HTML + CSS",
      "VPN + Proxy"
    ],
    answerIndex: 0,
    feedbackCorrect: "Correct: This combination enables OpenPGP features in the client setup.",
    feedbackWrong: "Not quite. Enigmail with GnuPG enables OpenPGP features.",
    recovery: { q: "True/False: Enigmail and GnuPG are used together for OpenPGP features.", answerIndex: 0 }
  },
  {
    q: "With OpenPGP encryption, which part is still visible to email systems (not protected as message content)?",
    choices: [
      "Subject line",
      "Encrypted message body",
      "Encrypted attachment content",
      "Encrypted signature content"
    ],
    answerIndex: 0,
    feedbackCorrect: "Correct: The subject line remains visible.",
    feedbackWrong: "Not quite. The subject line remains visible.",
    recovery: { q: "True/False: The subject line is not protected like encrypted message content.", answerIndex: 0 }
  },
  {
    q: "Which item remains visible even when message content is encrypted?",
    choices: [
      "Recipientsâ€™ email addresses",
      "Encrypted message body",
      "Encrypted attachment content",
      "Your local copy in â€˜Sentâ€™"
    ],
    answerIndex: 0,
    feedbackCorrect: "Correct: Recipient addresses are visible as routing information.",
    feedbackWrong: "Not quite. Recipient addresses remain visible as routing information.",
    recovery: { q: "True/False: Recipient email addresses remain visible even if content is encrypted.", answerIndex: 0 }
  },
  {
    q: "If you use Inline PGP instead of PGP/MIME, what is a known drawback for attachments?",
    choices: [
      "Attachment file names may remain visible",
      "The subject line becomes hidden",
      "Recipients become hidden automatically",
      "The message becomes unreadable to the sender"
    ],
    answerIndex: 0,
    feedbackCorrect: "Correct: Attachment file names can remain visible with Inline PGP.",
    feedbackWrong: "Not quite. Attachment file names can remain visible with Inline PGP.",
    recovery: { q: "True/False: With Inline PGP, attachment file names may remain visible.", answerIndex: 0 }
  },
  {
    q: "If some email details remain visible, what is a sensible habit when writing messages?",
    choices: [
      "Put confidential information in the subject line",
      "Choose subject lines carefully and avoid sensitive details there",
      "Always add your full address and ID number",
      "Avoid encryption because it is unnecessary"
    ],
    answerIndex: 1,
    feedbackCorrect: "Correct: Avoid sensitive information in places that remain visible.",
    feedbackWrong: "Not quite. Avoid sensitive information in subject lines and visible fields.",
    recovery: { q: "True/False: It is wise to avoid sensitive details in the subject line.", answerIndex: 0 }
  },

  /* Extra questions to reduce repetition during longer sessions */
  {
    q: "A message claims â€œYour computer is infectedâ€ and urges you to open an attachment. What is the safer response?",
    choices: [
      "Open the attachment to check",
      "Treat it as suspicious and verify via trusted security tools/support",
      "Forward it to friends for advice",
      "Reply asking for the virus name"
    ],
    answerIndex: 1,
    feedbackCorrect: "Correct: Threat-based urgency is common in scams; verify safely.",
    feedbackWrong: "Not quite. Threat-based urgency is common; verify using trusted methods.",
    recovery: { q: "True/False: â€œUrgent virus warningsâ€ with attachments can be suspicious.", answerIndex: 0 }
  },
  {
    q: "Which pair is always visible during email delivery (even if the message body is encrypted)?",
    choices: [
      "Sender address and recipients list",
      "Encrypted body and encrypted attachments",
      "Passphrase and private key",
      "Local drafts and trash folder"
    ],
    answerIndex: 0,
    feedbackCorrect: "Correct: Sender/recipient addressing is necessary for routing.",
    feedbackWrong: "Not quite. Sender/recipient addressing is necessary for routing.",
    recovery: { q: "True/False: Sender and recipient addressing is visible for routing.", answerIndex: 0 }
  }
];

/* ============================================================
   Game settings
============================================================ */
const DIGITS_TOTAL = 10;
const SCORE_MAIN_CORRECT = 10;
const SCORE_RECOVERY_CORRECT = 5;

let state = {
  started: false,
  codeDigits: [],
  revealedCount: 0,

  score: 0,
  correct: 0,
  wrong: 0,

  streak: 0,

  currentQuestion: null, // {mode:'main'|'recovery', digitIndex, qObj}
  muted: false,

  usedQ: [],
  startTime: Date.now(),

  finishing: false
};

/* ============================================================
   Sound (no external files)
============================================================ */
function beep(type){
  if(state.muted) return;
  const ctx = beep.ctx || (beep.ctx = new (window.AudioContext || window.webkitAudioContext)());
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  const now = ctx.currentTime;

  const presets = {
    click: [420, 0.035, "sine"],
    good:  [760, 0.09, "triangle"],
    bad:   [170, 0.11, "sawtooth"],
    win:   [540, 0.16, "sine"]
  };
  const [freq, dur, wave] = presets[type] || presets.click;

  o.type = wave;
  o.frequency.setValueAtTime(freq, now);
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.16, now + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

  o.connect(g); g.connect(ctx.destination);
  o.start(now);
  o.stop(now + dur + 0.02);
}

/* ============================================================
   DOM helpers
============================================================ */
const el = (id)=>document.getElementById(id);
const overlay = el("overlay");
const qText = el("qText");
const choicesEl = el("choices");
const mTitle = el("mTitle");
const mSub = el("mSub");
const feedbackEl = el("feedback");
const nextBtn = el("nextBtn");
const closeBtn = el("closeBtn");
const toast = el("toast");
const modeBadge = el("modeBadge");
const digitsPanel = el("digitsPanel");

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 900);
}

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function formatTime(sec){
  sec = Math.max(0, Math.floor(sec));
  if(sec < 60) return sec + "s";
  const m = Math.floor(sec/60), s = sec%60;
  return `${m}m ${String(s).padStart(2,"0")}s`;
}

/* ============================================================
   Question selection (avoid repetition until needed)
============================================================ */
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function resetQuestionDeck(){
  state.usedQ = shuffle([...Array(QUESTION_BANK.length).keys()]);
}
function nextMainQuestion(){
  if(state.usedQ.length === 0) resetQuestionDeck();
  const idx = state.usedQ.pop();
  return QUESTION_BANK[idx];
}

/* ============================================================
   Digits UI
============================================================ */
function renderDigits(){
  const box = el("digits");
  box.innerHTML = "";

  for(let i=0;i<DIGITS_TOTAL;i++){
    const d = document.createElement("div");
    d.className = "digit" + (i < state.revealedCount ? " revealed" : "");
    if(i < state.revealedCount){
      d.innerHTML = `<span>${state.codeDigits[i]}</span>`;
    }else{
      d.innerHTML = `<div class="blur"></div>`;
    }
    box.appendChild(d);
  }
}
function popDigit(i){
  const digitEl = el("digits").children[i];
  if(!digitEl) return;
  digitEl.classList.add("revealPop");
  setTimeout(()=>digitEl.classList.remove("revealPop"), 520);
}

/* ============================================================
   HUD
============================================================ */
function updateHUD(){
  el("done").textContent = String(state.revealedCount);
  el("total").textContent = String(DIGITS_TOTAL);
  el("score").textContent = String(state.score);

  const attempted = state.correct + state.wrong;
  const acc = attempted ? Math.round((state.correct/attempted)*100) : 0;
  el("acc").textContent = acc + "%";
  el("correct").textContent = String(state.correct);
  el("wrong").textContent = String(state.wrong);

  const sec = (Date.now() - state.startTime)/1000;
  el("time").textContent = formatTime(sec);

  el("progressText").textContent = `Digits Verified: ${state.revealedCount} / ${DIGITS_TOTAL}`;
  el("streakText").textContent = `Streak: ${state.streak}`;

  const pct = Math.round((state.revealedCount / DIGITS_TOTAL) * 100);
  el("barFill").style.width = pct + "%";
  el("barText").textContent = `${pct}% verified`;
}
setInterval(updateHUD, 500);

/* ============================================================
   Modal
============================================================ */
function openModal(mode, digitIndex, qObj){
  state.currentQuestion = { mode, digitIndex, qObj };

  mTitle.textContent = `Digit ${digitIndex + 1}`;
  if(mode === "main"){
    mSub.textContent = "Main question â€¢ One attempt";
    modeBadge.textContent = "MAIN QUESTION";
    modeBadge.className = "badge";
    feedbackEl.textContent = "Choose the best answer.";
  }else{
    mSub.textContent = "Recovery question â€¢ One attempt";
    modeBadge.textContent = "RECOVERY";
    modeBadge.className = "badge bad";
    feedbackEl.textContent = "Answer to recover the digit.";
  }

  nextBtn.disabled = true;
  choicesEl.innerHTML = "";

  if(mode === "main"){
    qText.textContent = qObj.q;
    qObj.choices.forEach((ch, i)=>{
      const b = document.createElement("button");
      b.className = "choice";
      b.type = "button";
      b.textContent = ch;
      b.addEventListener("click", ()=> answerMain(i));
      choicesEl.appendChild(b);
    });
  }else{
    qText.textContent = qObj.recovery.q;
    const opts = ["True","False"];
    opts.forEach((ch, i)=>{
      const b = document.createElement("button");
      b.className = "choice";
      b.type = "button";
      b.textContent = ch;
      b.addEventListener("click", ()=> answerRecovery(i));
      choicesEl.appendChild(b);
    });
  }

  overlay.classList.add("show");
  beep("click");
}
function closeModal(){
  overlay.classList.remove("show");
}
closeBtn.addEventListener("click", ()=>{beep("click"); closeModal();});
overlay.addEventListener("click", (e)=>{
  if(e.target === overlay){beep("click"); closeModal();}
});

nextBtn.addEventListener("click", ()=>{
  beep("click");
  closeModal();

  if(state.revealedCount < DIGITS_TOTAL){
    setTimeout(()=> askNextDigit(), 320);
  }
});

function disableChoices(){
  [...choicesEl.querySelectorAll(".choice")].forEach(x=>x.disabled = true);
}

/* ============================================================
   Answer handling
============================================================ */
function answerMain(chosenIndex){
  const { digitIndex, qObj } = state.currentQuestion;

  disableChoices();

  const correct = chosenIndex === qObj.answerIndex;
  const btns = [...choicesEl.querySelectorAll(".choice")];

  btns.forEach((b, i)=>{
    if(i === qObj.answerIndex) b.classList.add("good");
    if(i === chosenIndex && !correct) b.classList.add("bad");
  });

  if(correct){
    state.score += SCORE_MAIN_CORRECT;
    state.correct += 1;
    state.streak += 1;
    feedbackEl.textContent = qObj.feedbackCorrect || "Correct.";
    modeBadge.className = "badge good";
    beep("good");
    revealDigit(digitIndex, true);
    nextBtn.disabled = false;
  }else{
    state.wrong += 1;
    state.streak = 0;
    feedbackEl.textContent = qObj.feedbackWrong || "Wrong. Recovery question will appear.";
    modeBadge.className = "badge bad";
    beep("bad");

    // subtle shake on wrong (more dramatic)
    const a = el("arena");
    a.classList.remove("shake"); void a.offsetWidth; a.classList.add("shake");

    setTimeout(()=>{
      openModal("recovery", digitIndex, qObj);
    }, 680);

    nextBtn.disabled = true;
  }
}

function answerRecovery(chosenIndex){
  const { digitIndex, qObj } = state.currentQuestion;
  disableChoices();

  const correct = chosenIndex === qObj.recovery.answerIndex;
  const btns = [...choicesEl.querySelectorAll(".choice")];
  btns.forEach((b, i)=>{
    if(i === qObj.recovery.answerIndex) b.classList.add("good");
    if(i === chosenIndex && !correct) b.classList.add("bad");
  });

  if(correct){
    state.score += SCORE_RECOVERY_CORRECT;
    state.correct += 1;
    feedbackEl.textContent = "Recovered â€” digit verified.";
    modeBadge.className = "badge good";
    beep("good");
    revealDigit(digitIndex, false);
  }else{
    state.wrong += 1;
    feedbackEl.textContent = "Recovery failed â€” digit remains locked. Continue to the next question.";
    modeBadge.className = "badge bad";
    beep("bad");

    // sparks on fail to make it feel "techy"
    fireSparks(false);

    // do NOT reveal digit; keep going (extra questions will continue until all digits are revealed)
  }

  nextBtn.disabled = false;
}

/* ============================================================
   Progress model
   - To keep completion realistic, we keep asking new questions until all 10 digits are revealed.
   - Each time you reveal, it unlocks the next digit position.
============================================================ */
function revealDigit(digitIndex, fromMain){
  if(digitIndex !== state.revealedCount) return;

  state.revealedCount += 1;
  renderDigits();
  popDigit(digitIndex);

  // stronger visual hit
  digitsPanel.classList.remove("unlockPulse");
  void digitsPanel.offsetWidth;
  digitsPanel.classList.add("unlockPulse");

  // micro sparks + micro confetti
  fireSparks(true);
  fireConfetti(false);

  showToast(fromMain ? "Digit revealed!" : "Digit recovered!");
  el("nextHint").textContent = "Next digit unlocked";
  el("note").innerHTML = `<b>Status:</b> Digit ${state.revealedCount} verified. Keep going.`;

  if(state.revealedCount >= DIGITS_TOTAL){
    finishVaultCinematic();
  }
}

/* ============================================================
   Game loop
============================================================ */
function askNextDigit(){
  if(!state.started || state.finishing) return;

  if(state.revealedCount >= DIGITS_TOTAL){
    finishVaultCinematic();
    return;
  }

  const digitIndex = state.revealedCount;
  const qObj = nextMainQuestion();
  openModal("main", digitIndex, qObj);

  el("nextHint").textContent = `Attempt Digit ${digitIndex + 1}`;
}

function startGame(){
  if(state.started) return;
  state.started = true;
  state.startTime = Date.now();
  el("startBtn").disabled = true;
  el("nextHint").textContent = "Attempt Digit 1";
  el("note").innerHTML = "<b>Status:</b> Game started. Answer MCQs to reveal digits.";
  askNextDigit();
}

function resetGame(){
  state.started = false;
  state.finishing = false;
  state.codeDigits = Array.from({length: DIGITS_TOTAL}, ()=> Math.floor(Math.random()*10));
  state.revealedCount = 0;

  state.score = 0;
  state.correct = 0;
  state.wrong = 0;
  state.streak = 0;

  state.currentQuestion = null;
  state.startTime = Date.now();

  resetQuestionDeck();
  renderDigits();
  updateHUD();

  // Reset visuals
  el("vaultStage").classList.remove("vaultDoorsOpen");
  el("finalBanner").classList.remove("show");
  el("finalSub").textContent = "All digits verified.";
  el("cinematicText").classList.remove("show");
  el("digitsPanel").classList.remove("digitsAllGlow");
  el("startBtn").disabled = false;
  el("nextHint").textContent = "Press Start";
  el("note").innerHTML = "<b>Status:</b> Press <b>Start</b> to begin. You will answer one MCQ per digit.";

  showToast("Reset done.");
}

/* ============================================================
   Cinematic finish (more attractive)
   Sequence:
   1) digits glow
   2) "verifying access" text
   3) sparks burst
   4) lock shackle lifts
   5) doors slide open + rays
   6) final banner + big confetti
============================================================ */
function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }

async function finishVaultCinematic(){
  if(state.finishing) return;
  state.finishing = true;

  closeModal();

  const stage = el("vaultStage");
  const cine = el("cinematicText");

  // Step 1: glow digits
  el("digitsPanel").classList.add("digitsAllGlow");
  cine.textContent = "VERIFYING ACCESSâ€¦";
  cine.classList.add("show");
  beep("win");
  fireSparks(true);
  await wait(520);

  // Step 2: pulse twice
  digitsPanel.classList.remove("unlockPulse"); void digitsPanel.offsetWidth; digitsPanel.classList.add("unlockPulse");
  await wait(420);
  digitsPanel.classList.remove("unlockPulse"); void digitsPanel.offsetWidth; digitsPanel.classList.add("unlockPulse");
  await wait(520);

  // Step 3: unlock moment + sparks
  cine.textContent = "LOCK RELEASED";
  fireSparks(true);
  await wait(500);

  // Step 4: doors open
  cine.textContent = "OPENING VAULTâ€¦";
  stage.classList.add("vaultDoorsOpen");
  await wait(900);

  // Step 5: big celebration
  cine.classList.remove("show");
  fireConfetti(true);
  fireSparks(true);

  el("finalBanner").classList.add("show");
  el("finalSub").textContent = "Vault opened successfully.";

  el("note").innerHTML = "<b>Result:</b> Access granted. Vault opened successfully.";
  el("nextHint").textContent = "Vault opened";
}

/* ============================================================
   Confetti + Sparks
============================================================ */
const confettiCanvas = el("confetti");
const sparksCanvas = el("sparks");
const confCtx = confettiCanvas.getContext("2d");
const spCtx = sparksCanvas.getContext("2d");
let confettiParticles = [];
let sparkParticles = [];

function resizeFX(){
  const box = el("vaultStage").getBoundingClientRect();
  const w = Math.floor(box.width * devicePixelRatio);
  const h = Math.floor(box.height * devicePixelRatio);

  [confettiCanvas, sparksCanvas].forEach(c=>{
    c.width = w; c.height = h;
    c.style.width = box.width + "px";
    c.style.height = box.height + "px";
  });
}
window.addEventListener("resize", resizeFX);

function fireConfetti(big){
  resizeFX();
  confettiCanvas.classList.add("show");
  setTimeout(()=>confettiCanvas.classList.remove("show"), 1200);

  const w = confettiCanvas.width, h = confettiCanvas.height;
  const count = big ? 220 : 70;

  for(let i=0;i<count;i++){
    confettiParticles.push({
      x: w*0.5 + (Math.random()-0.5)*w*0.32,
      y: h*0.30 + (Math.random()-0.5)*h*0.10,
      vx: (Math.random()-0.5) * (big ? 8 : 5) * devicePixelRatio,
      vy: (Math.random()*6 + 4) * devicePixelRatio,
      r: (Math.random()*5 + 3) * devicePixelRatio,
      rot: Math.random()*Math.PI,
      vr: (Math.random()-0.5)*0.25,
      life: 1,
      fade: Math.random()*0.02 + 0.012
    });
  }
}

function fireSparks(big){
  resizeFX();
  sparksCanvas.classList.add("show");
  setTimeout(()=>sparksCanvas.classList.remove("show"), 900);

  const w = sparksCanvas.width, h = sparksCanvas.height;
  const count = big ? 90 : 40;

  for(let i=0;i<count;i++){
    const ang = Math.random()*Math.PI*2;
    const spd = (Math.random()*(big?10:7) + 3) * devicePixelRatio;
    sparkParticles.push({
      x: w*0.5,
      y: h*0.56,
      vx: Math.cos(ang)*spd,
      vy: Math.sin(ang)*spd - (Math.random()*2*devicePixelRatio),
      life: 1,
      fade: Math.random()*0.05 + 0.03,
      r: (Math.random()*2.5 + 1.2) * devicePixelRatio
    });
  }
}

function tickFX(){
  const w = confettiCanvas.width, h = confettiCanvas.height;

  // confetti
  confCtx.clearRect(0,0,w,h);
  confettiParticles.forEach(p=>{
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.14 * devicePixelRatio;
    p.rot += p.vr;
    p.life -= p.fade;

    confCtx.save();
    confCtx.translate(p.x, p.y);
    confCtx.rotate(p.rot);
    confCtx.globalAlpha = clamp(p.life,0,1);
    confCtx.fillStyle = `hsl(${Math.floor(Math.random()*360)}, 90%, 60%)`;
    confCtx.fillRect(-p.r, -p.r*0.5, p.r*2, p.r);
    confCtx.restore();
  });
  confettiParticles = confettiParticles.filter(p=>p.life>0 && p.y < h + 80*devicePixelRatio);

  // sparks
  spCtx.clearRect(0,0,w,h);
  sparkParticles.forEach(s=>{
    s.x += s.vx;
    s.y += s.vy;
    s.vx *= 0.92;
    s.vy *= 0.92;
    s.life -= s.fade;

    spCtx.save();
    spCtx.globalAlpha = clamp(s.life,0,1);
    spCtx.beginPath();
    spCtx.arc(s.x, s.y, s.r, 0, Math.PI*2);
    spCtx.fillStyle = "rgba(247,211,106,0.95)";
    spCtx.fill();
    spCtx.restore();
  });
  sparkParticles = sparkParticles.filter(s=>s.life>0);

  requestAnimationFrame(tickFX);
}
tickFX();

/* ============================================================
   Buttons
============================================================ */
el("startBtn").addEventListener("click", ()=>{ beep("click"); startGame(); });
el("resetBtn").addEventListener("click", ()=>{ beep("click"); resetGame(); });
el("muteBtn").addEventListener("click", ()=>{
  state.muted = !state.muted;
  el("muteBtn").textContent = state.muted ? "ðŸ”‡ Muted" : "ðŸ”Š Sound";
  showToast(state.muted ? "Sound off" : "Sound on");
});

/* ============================================================
   Init
============================================================ */
function init(){
  resetGame();
  resizeFX();
}
init();
</script>
</body>
</html>
